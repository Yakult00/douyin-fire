import time
import json
import logging
from playwright.sync_api import sync_playwright
from one import wenan

# é…ç½®æ—¥å¿—è®°å½•
def setup_logging():
    log_file = 'exception_log.txt'
    logging.basicConfig(filename=log_file, level=logging.ERROR, encoding='utf-8',
                        format='%(asctime)s - %(levelname)s - %(message)s')

# è®°å½•å¼‚å¸¸ä¿¡æ¯
def log_exception(exception, message=None):
    if message:
        logging.error(message)
    logging.exception(exception)

# åŠ è½½cookies
def load_cookies(cookie_file):
    try:
        with open(cookie_file, 'r', encoding='utf-8') as f:
            return json.loads(f.read())
    except (FileNotFoundError, json.JSONDecodeError) as e:
        log_exception(e, f"è¯»å–æˆ–è§£æcookieæ–‡ä»¶æ—¶å‡ºé”™ï¼š{e}")
        return None

# å‘é€æ¶ˆæ¯
def send_message(page, name, text):
    try:
        print(f"æ­£åœ¨å‘é€æ¶ˆæ¯ç»™ {name}...")
        page.get_by_text(name).click()
        page.locator("#douyin-header-menuCt").get_by_role("textbox").locator("div").nth(2).click()
        page.locator("#douyin-header-menuCt").get_by_role("textbox").fill(text)
        page.locator(".PygT7Ced > svg > path:nth-child(2)").click()
        print(f"æ¶ˆæ¯å‘é€ç»™ {name} æˆåŠŸ")
        return True
    except Exception as e:
        log_exception(e, f"æ“ä½œ {name} æ—¶å‡ºé”™ï¼š{e}")
        return False

# å°è¯•ç‚¹å‡»ç§ä¿¡æŒ‰é’®
def click_private_message_button(page):
    max_attempts = 3  # æœ€å¤§å°è¯•æ¬¡æ•°
    for attempt in range(max_attempts):
        try:
            print(f"å°è¯•ç‚¹å‡»ç§ä¿¡æŒ‰é’®ï¼ˆç¬¬ {attempt + 1} æ¬¡ï¼‰...")
            # ç­‰å¾…ç§ä¿¡æŒ‰é’®å‡ºç°
            page.wait_for_selector("text=ç§ä¿¡", timeout=10000)
            # æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°ç§ä¿¡æŒ‰é’®
            count = page.locator("text=ç§ä¿¡").count()
            print(f"æ‰¾åˆ° {count} ä¸ªç§ä¿¡æŒ‰é’®")
            if count > 0:
                # ä½¿ç”¨æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨ç‚¹å‡»ç§ä¿¡æŒ‰é’®
                page.get_by_text("ç§ä¿¡").click()
                print("ç§ä¿¡æŒ‰é’®ç‚¹å‡»æˆåŠŸ")
                return True
            else:
                print("æœªæ‰¾åˆ°ç§ä¿¡æŒ‰é’®")
        except Exception as e:
            log_exception(e, f"ç‚¹å‡»ç§ä¿¡æŒ‰é’®æ—¶å‡ºé”™ï¼ˆç¬¬ {attempt + 1} æ¬¡ï¼‰ï¼š{e}")
        time.sleep(1)  # æ¯æ¬¡å°è¯•åç­‰å¾… 1 ç§’
    return False

# ä¸»é€»è¾‘
def run(playwright):
    setup_logging()

    cookie_file = 'ck.txt'
    cookies = load_cookies(cookie_file)
    if not cookies:
        print("æœªåŠ è½½åˆ°æœ‰æ•ˆçš„ cookiesï¼Œç¨‹åºé€€å‡º")
        return

    browser = playwright.chromium.launch(headless=False)
    context = browser.new_context()
    page = context.new_page()

    try:
        print("æ­£åœ¨è®¿é—®æŠ–éŸ³é¦–é¡µ...")
        page.goto("https://douyin.com/")
        context.clear_cookies()
        for cookie in cookies:
            if 'expiry' in cookie:
                del cookie["expiry"]
            context.add_cookies([cookie])

        print("é‡æ–°åŠ è½½é¡µé¢...")
        page.reload()

        # å°è¯•ç‚¹å‡»ç§ä¿¡æŒ‰é’®
        if not click_private_message_button(page):
            print("ç§ä¿¡æŒ‰é’®ç‚¹å‡»å¤±è´¥ï¼Œç¨‹åºé€€å‡º")
            return

        names = ["sbsbç½®é¡¶", "å¤§çœ¼", "äºˆæµ…å¤", "æ˜¯å—ğŸ˜³"]
        first_click_success = 0
        text = wenan()

        if not text:
            print("æ–‡æ¡ˆä¸ºç©ºï¼Œæ— æ³•å‘é€æ¶ˆæ¯")
            return

        for name in names:
            if send_message(page, name, text):
                first_click_success += 1
                if first_click_success == 1:
                    print("é¦–æ¬¡å‘é€æˆåŠŸï¼Œç‚¹å‡»ä¾§è¾¹æ ")
                    page.locator(".FNb7nM4O > svg").click()
            time.sleep(0.7)

        current_cookies = context.cookies()
        print("å½“å‰ cookies:", current_cookies)

    except Exception as e:
        log_exception(e, "æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼š{e}")
    finally:
        print("å…³é—­æµè§ˆå™¨...")
        browser.close()

if __name__ == "__main__":
    with sync_playwright() as playwright:
        run(playwright)
